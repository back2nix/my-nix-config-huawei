#!/usr/bin/env fish

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ DNS –≤ NixOS
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ DNS..."
echo "=================================================="

# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ systemd-resolved
echo -e "\nüìä –°—Ç–∞—Ç—É—Å systemd-resolved:"
systemctl status systemd-resolved --no-pager -l 2>/dev/null || echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å resolved"

# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–∏—Ö DNS –Ω–∞—Å—Ç—Ä–æ–µ–∫
echo -e "\nüåê –¢–µ–∫—É—â–∏–µ DNS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:"
resolvectl status 2>/dev/null || echo "‚ùå resolvectl –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"

# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ DoT —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
echo -e "\nüîí –ü—Ä–æ–≤–µ—Ä–∫–∞ DoT —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π:"
resolvectl query cloudflare-dns.com --type=A 2>/dev/null || echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å DoT –∑–∞–ø—Ä–æ—Å"

# 4. –ê–Ω–∞–ª–∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –Ω–∞ –ø–æ—Ä—Ç 853 (DoT)
echo -e "\nüîå –ê–∫—Ç–∏–≤–Ω—ã–µ DoT —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (–ø–æ—Ä—Ç 853):"
ss -tuln | grep :853 2>/dev/null || echo "‚ùå –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö DoT —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π"
netstat -tulpn 2>/dev/null | grep :853 || echo "‚ùå netstat –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç DoT —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è"

# 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ resolved
echo -e "\n‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è resolved:"
cat /etc/systemd/resolved.conf 2>/dev/null || echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥ resolved"

# 6. –¢–µ—Å—Ç DNS –∑–∞–ø—Ä–æ—Å–∞ —Å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç—è–º–∏
echo -e "\nüß™ –¢–µ—Å—Ç–æ–≤—ã–π DNS –∑–∞–ø—Ä–æ—Å:"
dig @1.1.1.1 example.com +short 2>/dev/null || echo "‚ùå dig –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
nslookup example.com 2>/dev/null || echo "‚ùå nslookup –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"

# 7. –ü—Ä–æ–≤–µ—Ä–∫–∞ DNS —á–µ—Ä–µ–∑ resolved
echo -e "\nüîç DNS —á–µ—Ä–µ–∑ systemd-resolved:"
resolvectl query example.com 2>/dev/null || echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ resolved"

# 8. –ê–Ω–∞–ª–∏–∑ —Å–µ—Ç–µ–≤–æ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞ (–∫—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π)
echo -e "\nüìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ resolved:"
sudo resolvectl statistics 2>/dev/null || echo "‚ùå –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞"

# 9. –ü—Ä–æ–≤–µ—Ä–∫–∞, –∫–∞–∫–æ–π DNS —Å–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç
echo -e "\nüåç –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ DNS –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞:"
dig TXT o-o.myaddr.l.google.com @resolver1.opendns.com +short 2>/dev/null || echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞"

# 10. –ü—Ä–æ–≤–µ—Ä–∫–∞ DNS —É—Ç–µ—á–µ–∫ —á–µ—Ä–µ–∑ curl
echo -e "\nüíß –ü—Ä–æ–≤–µ—Ä–∫–∞ DNS —É—Ç–µ—á–µ–∫:"
curl -s "https://1.1.1.1/cdn-cgi/trace" 2>/dev/null | grep -E "(ip=|loc=)" || echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Ç–µ—á–∫–∏ —á–µ—Ä–µ–∑ Cloudflare"

# 11. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ resolved
echo -e "\nüì° –ê–Ω–∞–ª–∏–∑ DNS —Ç—Ä–∞—Ñ–∏–∫–∞ (5 —Å–µ–∫—É–Ω–¥):"
if command -v tcpdump > /dev/null 2>&1
    echo "–ó–∞–ø—É—Å–∫ tcpdump –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ DNS —Ç—Ä–∞—Ñ–∏–∫–∞..."
    timeout 5s sudo tcpdump -i any port 53 or port 853 -c 10 2>/dev/null || echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞—Ö–≤–∞—Ç–∏—Ç—å —Ç—Ä–∞—Ñ–∏–∫"
else
    echo "‚ùå tcpdump –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
end

# 12. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∂—É—Ä–Ω–∞–ª–æ–≤ resolved
echo -e "\nüìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏ resolved (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10):"
journalctl -u systemd-resolved --no-pager -n 10 2>/dev/null || echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∂—É—Ä–Ω–∞–ª—ã"

# 13. –ü—Ä–æ–≤–µ—Ä–∫–∞ DoT —á–µ—Ä–µ–∑ openssl
echo -e "\nüîê –¢–µ—Å—Ç DoT —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ openssl:"
echo | timeout 5s openssl s_client -connect 1.1.1.1:853 -servername cloudflare-dns.com 2>/dev/null | grep -E "(CONNECTED|Verify return code)" || echo "‚ùå DoT —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ openssl –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"

# 14. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ DNS —Å–µ—Ä–≤–µ—Ä–∞
echo -e "\nüéØ –¢–µ–∫—É—â–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π DNS:"
cat /etc/resolv.conf 2>/dev/null || echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å resolv.conf"

echo -e "\n‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo "=================================================="
echo "üí° –ï—Å–ª–∏ –≤—ã –≤–∏–¥–∏—Ç–µ DoT —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –Ω–∞ –ø–æ—Ä—Ç—É 853 –∏"
echo "   resolved –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã, —Ç–æ"
echo "   –≤–∞—à DNS —Ç—Ä–∞—Ñ–∏–∫ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω."
