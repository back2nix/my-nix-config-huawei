# Моя конфигурация NixOS

![NixOS Logo](https://raw.githubusercontent.com/NixOS/nixos-artwork/master/logo/nixos-logo-only-hires.png)

Это мой персональный репозиторий с конфигурацией NixOS, управляемый с помощью [Nix Flakes](https://nixos.wiki/wiki/Flakes). Он спроектирован для декларативного управления несколькими машинами с общей базой и специфичными для каждого устройства настройками.

## Философия и ключевые особенности

Цель этой конфигурации — создать воспроизводимую, гибкую и легко управляемую среду на всех моих устройствах.

*   **Мульти-девайс:** Единая кодовая база для управления несколькими компьютерами (`asus`, `huawei`, `yoga14`). Новые устройства добавляются с минимальными усилиями.
*   **Декларативность до мелочей:**
    *   **Система:** `NixOS` для полной конфигурации ОС.
    *   **Пользовательская среда:** [Home Manager](https://github.com/nix-community/home-manager) для управления dotfiles, пакетами и сервисами на уровне пользователя.
    *   **Редактор:** [NixVim](https://github.com/nix-community/nixvim) для декларативной настройки Neovim.
*   **Управление секретами:** Интеграция с [sops-nix](https.github.com/Mic92/sops-nix) для безопасного и версионируемого хранения секретов прямо в Git.
*   **Гибкость версий пакетов:** Используются несколько каналов `nixpkgs` (`stable`, `unstable`, `master`) для возможности устанавливать свежие версии пакетов там, где это необходимо, сохраняя стабильность основной системы.
*   **Специализированные модули:**
    *   **Аудио:** Интегрирован [Musnix](https://github.com/musnix/musnix) для настройки системы под задачи аудио-производства (real-time ядро, JACK и т.д.).
    *   **Сетевая безопасность и приватность:** Обширная коллекция модулей для управления VPN (WireGuard), прокси (Shadowsocks, Xray), DNS (DoH, DoT, blocky) и обхода блокировок (SpoofDPI).
    *   **Специфичное оборудование:** Используется [nixos-hardware](https://github.com/NixOS/nixos-hardware) для готовых конфигураций под конкретные модели ноутбуков.

## Структура проекта

Проект организован следующим образом для максимальной переиспользуемости и понятности:

*   `flake.nix`: Центральный файл. Определяет зависимости (inputs), структуру (outputs) и собирает конфигурации для всех хостов.
*   `configuration.nix`: Общая базовая конфигурация, которая применяется ко всем системам. Включает в себя фундаментальные настройки (локаль, ядро, базовые пакеты).
*   `/devices`: Директория с конфигурациями для каждого конкретного устройства.
    *   `devices/<hostname>/default.nix`: Специфичные настройки для хоста (например, драйверы, настройки дисплея).
    *   `devices/<hostname>/hardware-configuration.nix`: Автоматически сгенерированная конфигурация оборудования (диски, файловые системы).
*   `/module`: Коллекция переиспользуемых модулей NixOS, которые можно подключать по необходимости.
    *   `users/bg/`: Конфигурация Home Manager для моего пользователя `bg`. Здесь живут настройки shell (zsh, fish), терминала (kitty), редактора (nixvim) и других пользовательских программ.
    *   `vpn/`, `security.nix`, `dns-*.nix`: Модули, отвечающие за сетевые настройки и безопасность.
*   `/overlays`: Пользовательские оверлеи для модификации или добавления пакетов, которых нет в `nixpkgs`.
*   `/sops`: Модули и конфигурация для `sops-nix`. Файл с зашифрованными секретами находится в `secrets/secrets.yaml`.

## Как это использовать

### Требования

*   Установленная NixOS с включенной поддержкой Flakes.
*   Git.

### Развертывание на существующей машине

File: .env
```env
DEVICE=yoga14
```

1.  Клонируйте репозиторий:
    ```bash
    git clone https://github.com/back2nix/my-nix-config-huawei
    ln -s /home/$USER/Documents/code/github.com/back2nix/nix/my-nix-config-huawei /etc/nixos
    # recover secrets
    cp -r /backup/.config/sops /home/$USER/.config/sops

    ```
2.  Запустите сборку и применение конфигурации. Замените `<hostname>` на имя вашего компьютера, которое должно совпадать с одним из `nixosConfigurations` в `flake.nix` (`asus`, `huawei`, `yoga14`).

    ```bash
    # Собрать, протестировать и переключиться на новую конфигурацию
    sudo nixos-rebuild switch --flake /etc/nixos#<hostname>

    # Если вы просто хотите протестировать сборку без применения
    nixos-rebuild build --flake .#<hostname>
    ```

### update nixvim only

```bash
make update/nixvim
```

### Добавление нового устройства

1.  Установите базовую NixOS на новое устройство.
2.  На новом устройстве сгенерируйте начальную конфигурацию оборудования:
    ```bash
    sudo nixos-generate-config --no-filesystems --root /mnt
    # Скопируйте /mnt/etc/nixos/hardware-configuration.nix
    ```
3.  В этом репозитории создайте новую директорию `devices/<new_hostname>`.
4.  Поместите `hardware-configuration.nix` в эту новую директорию.
5.  Создайте в ней `default.nix` для специфичных настроек нового устройства.
6.  Добавьте новую машину в `nixosConfigurations` в файле `flake.nix` по аналогии с существующими:
    ```nix
    # flake.nix
    # ...
    in {
      asus = mkSystem "asus-ux3405m" [];
      huawei = mkSystem "huawei-rlef-x" [];
      yoga14 = mkSystem "yoga14" [];
      new-machine = mkSystem "new_hostname" []; # Ваша новая машина
    };
    ```
7.  Закоммитьте изменения и выполните развертывание на новой машине.

### Управление секретами

Секреты управляются с помощью `sops-nix`.

*   Основной файл с зашифрованными данными: `secrets/secrets.yaml`.
*   Для редактирования секретов используйте команду `sops secrets/secrets.yaml`. Для этого у вас должен быть доступ к одному из GPG/age ключей, указанных в файле `.sops.yaml` (этот файл обычно не коммитится и содержит публичные ключи).
*   Во время сборки системы `sops-nix` автоматически расшифрует секреты и поместит их в указанные в конфигурации пути с нужными правами.

---

Этот проект является постоянным экспериментом. Я всегда рад предложениям и замечаниям
